define(["require","exports","tslib","external/react","modules/clean/react/file_viewer/seen_state_facepile","modules/clean/react/pass/utils","modules/clean/sharing/api/types/metadata","modules/clean/sharing/constants","modules/clean/sharing/stores/sharing_info"],function(e,t,n,s,o,r,a,i,l){"use strict";var u=r.PassHelpers,p=s.createElement,_=function(e){function t(t){var n=e.call(this,t)||this;return n.boundUpdate=null,n.state=n._getStateFromStore(),n.boundUpdate=n._onUpdateFromStore.bind(n),n}return n.__extends(t,e),t.prototype._onUpdateFromStore=function(){this.setState(this._getStateFromStore())},t.prototype._getStateFromStore=function(){return{sharingInfo:l.getSharingInfo(this.props.user.id,this.props.file.file_id)}},t.prototype._getMemberInfosInPassFormat=function(){return{invitees:this._getInviteeMemberInfos(),users:this._getUserMemberInfos()}},t.prototype._getUserMemberInfos=function(){var e=this.state.sharingInfo.members().get("users");return e.valueSeq().toArray().map(function(e){return{when_last_seen:null,seen_state_user:{user_id:e.account_id,display_name:e.account?e.account.display_name:null,photo_url:e.account?e.account.profile_photo_url:null}}})},t.prototype._getInviteeMemberInfos=function(){var e=this.state.sharingInfo.members().get("invitees");return e.valueSeq().toArray().map(function(e){return{when_last_seen:null,seen_state_user:{display_name:e.contact}}})},t.prototype._getGroupInfos=function(){var e=this.state.sharingInfo.members().get("groups");return e.valueSeq().toArray().map(function(e){return{access_type:e.access_type,is_automatic:"team"===e.group_type,name:e.group_name,num_users:e.member_count,gid:e.group_id}})},t.prototype._getTruelinkInfo=function(){var e=this.state.sharingInfo.metadata().get("link_metadata");if(!e)return null;var t,n;switch(e.current_audience){case a.LinkAudience.members:return null;case a.LinkAudience.public:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.PUBLIC,n="ALL";break;default:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.TEAM_ONLY,n="MEMBERS_ONLY"}e.get("password_protected")&&(t=i.SHMODEL_LINK_TOKEN_VISIBILITY.PASSWORD);var s=this.state.sharingInfo.metadata().file_policy.download_policy===a.DownloadPolicy.disallow,o=e.expiry?Date.parse(e.expiry.toString())/1e3:null;return{visibility_type:t,expires_posix:o,shared_folder_link_policy:n,allow_download:!s}},t.prototype._getShmodelInfo=function(){var e=this.state.sharingInfo.linkMetadata();if(!e)return null;var t,n;switch(e.link_permissions.get(a.ResolvedVisibilityPolicy.policy_name)){case a.ResolvedVisibilityPolicy.public:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.PUBLIC,n="ALL";break;case a.ResolvedVisibilityPolicy.team_only:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.TEAM_ONLY,n="MEMBERS_ONLY";break;case a.ResolvedVisibilityPolicy.team_and_password:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.PASSWORD,n="MEMBERS_ONLY";break;case a.ResolvedVisibilityPolicy.password:t=i.SHMODEL_LINK_TOKEN_VISIBILITY.PASSWORD,n="ALL"}return{expires_posix:e.expires?Date.parse(e.expires.toString())/1e3:null,visibility_type:t,shared_folder_link_policy:n,allow_download:e.link_permissions.allow_download}},t.prototype.componentWillMount=function(){l.add_change_listener(this.boundUpdate),this.props.fromBrowse&&u.setup(this.props.user,{file:this.props.file,url:this.props.url},null,!1)},t.prototype._getPropsFromSharingInfo=function(){var e={sharedLinkInfo:null,sharingStorePassInfo:{},groups:[],haveMembersLoaded:!1,hasMemberCountLoaded:!1,hasSharedLinkInfoLoaded:!1,uniqueMemberCount:null};return this.state.sharingInfo?(null!=this.state.sharingInfo.memberCounts()&&(e.uniqueMemberCount=this.state.sharingInfo.memberCounts().total_unique_users,e.hasMemberCountLoaded=!0),this.state.sharingInfo.hasDisplayableMembers()&&(e.haveMembersLoaded=!0,e.sharingStorePassInfo=this._getMemberInfosInPassFormat(),e.groups=this._getGroupInfos()),this.props.file.fq_path?i.TRUELINK.TRUELINK_UI[this.props.user.id]&&this.state.sharingInfo.isMetadataLoaded()?(e.hasSharedLinkInfoLoaded=!0,e.sharedLinkInfo=this._getTruelinkInfo()):!i.TRUELINK.TRUELINK_UI[this.props.user.id]&&this.state.sharingInfo.isLinkMetadataLoaded()&&(e.hasSharedLinkInfoLoaded=!0,e.sharedLinkInfo=this._getShmodelInfo()):(e.hasSharedLinkInfoLoaded=!0,e.sharedLinkInfo=null),e):e},t.prototype.render=function(){var e=n.__assign({},this._getPropsFromSharingInfo(),this.props);return p(o,e)},t.prototype.componentWillUnmount=function(){l.remove_change_listener(this.boundUpdate)},t}(s.Component);_.displayName="SeenStateFacepileController",t.SeenStateFacepileController=_});
//# sourceMappingURL=seen_state_facepile_controller.min.js-vflfHL0er.map